<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>LuluGo - ç®¡ç†å‘˜</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; display: flex; gap: 20px; }
        .panel { flex: 1; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; color: #555; }
        .item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .item:last-child { border-bottom: none; }
        .btn-del { background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; transition: background 0.2s; }
        .btn-del:hover { background: #c0392b; }
        .status-badge { padding: 2px 6px; border-radius: 3px; font-size: 0.8em; color: white; }
        .status-WAITING { background: #f39c12; }
        .status-PLAYING { background: #2ecc71; }
        .status-ENDED { background: #7f8c8d; }
    </style>
</head>
<body>
    <h1>LuluGo ç®¡ç†åå°</h1>
    
    <div class="container">
        <!-- ç”¨æˆ·ç®¡ç† -->
        <div class="panel">
            <h2>ğŸ‘¤ ç”¨æˆ·ç®¡ç†</h2>
            <div id="user-list">åŠ è½½ä¸­...</div>
        </div>

        <!-- å¯¹å±€ç®¡ç† -->
        <div class="panel">
            <h2>ğŸ® å¯¹å±€ç®¡ç†</h2>
            <div id="game-list">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <script>
        async function loadData() {
            await Promise.all([loadUsers(), loadGames()]);
        }

        async function loadUsers() {
            try {
                const res = await fetch('/api/users');
                const data = await res.json();
                const users = data.users || [];
                
                document.getElementById('user-list').innerHTML = users.map(u => `
                    <div class="item">
                        <div>
                            <strong>${u.username}</strong> <span style="color:#999; font-size:0.9em;">(ID: ${u.id})</span>
                            <br><small style="color:#bbb;">æ³¨å†Œ: ${new Date(u.created_at).toLocaleDateString()}</small>
                        </div>
                        <button class="btn-del" onclick="deleteUser(${u.id}, '${u.username}')">åˆ é™¤ç”¨æˆ·</button>
                    </div>
                `).join('') || '<div style="padding:10px; text-align:center; color:#999;">æš‚æ— ç”¨æˆ·</div>';
            } catch (e) {
                console.error(e);
                document.getElementById('user-list').innerHTML = '<div style="color:red">åŠ è½½å¤±è´¥</div>';
            }
        }

        async function loadGames() {
            try {
                const [w, p, h] = await Promise.all([
                    (await fetch('/api/games/waiting')).json(),
                    (await fetch('/api/games/playing')).json(),
                    (await fetch('/api/games/history')).json()
                ]);
                
                // Helper to format games
                const format = (list, defaultStatus) => list.map(g => ({...g, _status: g.status || defaultStatus}));
                
                const all = [
                    ...format(w.games, 'WAITING'),
                    ...format(p.games, 'PLAYING'),
                    ...format(h.games, 'ENDED')
                ].sort((a,b) => b.id - a.id);

                document.getElementById('game-list').innerHTML = all.map(g => {
                    let statusClass = 'status-' + (g._status === 'FINISHED' ? 'ENDED' : g._status);
                    return `
                    <div class="item">
                        <div>
                            <span class="status-badge ${statusClass}">${g._status}</span> 
                            <strong>#${g.id}</strong>
                            <span style="margin: 0 5px;">âš«${g.black} vs âšª${g.white}</span>
                        </div>
                        <button class="btn-del" onclick="deleteGame(${g.id})">åˆ é™¤</button>
                    </div>
                `}).join('') || '<div style="padding:10px; text-align:center; color:#999;">æš‚æ— å¯¹å±€</div>';
            } catch (e) {
                console.error(e);
                document.getElementById('game-list').innerHTML = '<div style="color:red">åŠ è½½å¤±è´¥</div>';
            }
        }
        
        async function deleteGame(id) {
            if(confirm(`ç¡®å®šè¦åˆ é™¤å¯¹å±€ #${id} å—ï¼Ÿ`)) {
                await fetch(`/api/games/${id}`, { method: 'DELETE' });
                loadGames();
            }
        }

        async function deleteUser(id, name) {
            if(confirm(`âš ï¸ è­¦å‘Šï¼\n\nç¡®å®šè¦åˆ é™¤ç”¨æˆ· "${name}" (ID: ${id}) å—ï¼Ÿ\n\nè¿™å°†åŒæ—¶åˆ é™¤æ‰€æœ‰è¯¥ç”¨æˆ·å‚ä¸çš„å¯¹å±€ï¼æ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚`)) {
                const res = await fetch(`/api/users/${id}`, { method: 'DELETE' });
                const data = await res.json();
                if(data.success) {
                    alert(data.msg);
                    loadData(); // Reload both lists
                } else {
                    alert("åˆ é™¤å¤±è´¥: " + data.detail);
                }
            }
        }

        loadData();
    </script>
</body>
</html>